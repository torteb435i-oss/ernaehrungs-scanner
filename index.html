<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nutrition AI Pro - Fixed & Ultra</title>
    
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    
    <style>
        :root { --primary: #007AFF; --bg: #f5f5f7; --text: #1d1d1f; --green: #34c759; --red: #ff3b30; --warn: #ff9500; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; color: var(--text); padding-bottom: 50px; }
        header { background: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top:0; z-index:100; }
        .container { width: 92%; max-width: 440px; margin: 20px auto; }
        
        #reader-wrapper { width: 100%; border-radius: 25px; overflow: hidden; background: #000; box-shadow: 0 10px 30px rgba(0,0,0,0.2); border: 2px solid var(--primary); position: relative; }
        #reader { width: 100%; }

        .btn { background: var(--primary); color: white; border: none; padding: 18px; border-radius: 18px; font-size: 1rem; font-weight: bold; width: 100%; cursor: pointer; margin-top: 10px; }
        .btn-ocr { background: var(--green); }
        
        .card { background: white; border-radius: 25px; padding: 22px; margin-top: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .status { text-align: center; padding: 10px; font-size: 0.85rem; color: var(--primary); font-weight: bold; }
        
        .additive-box { padding: 12px; border-radius: 15px; margin-bottom: 10px; border-left: 6px solid #ccc; background: #f9f9f9; }
        .low { border-left-color: var(--green); }
        .med { border-left-color: var(--warn); }
        .high { border-left-color: var(--red); }
        
        .hidden { display: none !important; }
        canvas { display: none; }
    </style>
</head>
<body>

<header><strong>NUTRITION VISION PRO</strong></header>

<div class="container">
    <div id="reader-wrapper">
        <div id="reader"></div>
    </div>
    
    <div id="status" class="status">Kamera wird gestartet...</div>

    <div id="controls">
        <button class="btn btn-ocr" onclick="startOCR()">1. ZUTATEN-TEXT ANALYSIEREN</button>
        <p style="text-align:center; font-size:0.7rem; color:#666; margin:5px 0;">Oder einfach Barcode vor die Kamera halten</p>
    </div>

    <div id="result" class="card hidden">
        <h3 id="res-name" style="margin-top:0;">Analyse-Ergebnis</h3>
        <div id="res-list"></div>
        <button class="btn" style="background:#8e8e93;" onclick="resetUI()">Neu scannen</button>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between;">
            <h4 style="margin:0;">VERLAUF</h4>
            <button onclick="exportData()" style="background:none; border:none; color:var(--primary); font-weight:bold; cursor:pointer;">EXPORT</button>
        </div>
        <div id="history-list" style="font-size: 0.8rem; margin-top:10px;"></div>
    </div>
</div>

<script>
    let html5QrCode;
    let worker;

    // EXPERTEN-DATENBANK FÜR KLARTEXT-ANALYSE
    const MASTER_DB = {
        "e440": { name: "Pektin (E440)", risk: "low", info: "Natürlicher Ballaststoff aus Früchten. Sehr gesund für den Darm." },
        "maltodextrin": { name: "Maltodextrin", risk: "med", info: "Versteckter Zucker. Lässt den Blutzucker schnell ansteigen." },
        "e621": { name: "Glutamat (E621)", risk: "high", info: "Geschmacksverstärker. Kann das Sättigungsgefühl stören." },
        "palm": { name: "Palmfett", risk: "high", info: "Industriefett. Ungesund für Herz und Umwelt." },
        "e322": { name: "Lecithin", risk: "low", info: "Wichtiger Stoff für Nerven und Gehirn." }
    };

    async function startCamera() {
        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 15, qrbox: { width: 250, height: 150 } };
        
        // Barcode-Scan läuft im Hintergrund permanent mit
        html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
            fetchProductData(decodedText);
        }).catch(err => {
            document.getElementById('status').innerText = "Kamera-Fehler: " + err;
        });

        // Tesseract KI im Hintergrund laden
        worker = await Tesseract.createWorker('deu');
        document.getElementById('status').innerText = "Bereit für Barcode oder Text.";
    }

    async function fetchProductData(barcode) {
        document.getElementById('status').innerText = "Suche Produkt...";
        try {
            const resp = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}.json`);
            const data = await resp.json();
            if(data.status === 1) {
                showResult(data.product.product_name, data.product.additives_tags || []);
            } else {
                document.getElementById('status').innerText = "Produkt unbekannt. Bitte Text-Scan nutzen.";
            }
        } catch(e) {
            document.getElementById('status').innerText = "Netzwerkfehler.";
        }
    }

    async function startOCR() {
        document.getElementById('status').innerText = "KI analysiert Text...";
        const video = document.querySelector('video');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        const { data: { text } } = await worker.recognize(canvas);
        const lowerText = text.toLowerCase();
        
        let found = [];
        for(let key in MASTER_DB) {
            if(lowerText.includes(key)) found.push(MASTER_DB[key]);
        }
        
        displayOCRResult(found);
    }

    function displayOCRResult(found) {
        const resList = document.getElementById('res-list');
        resList.innerHTML = "";
        
        if(found.length > 0) {
            found.forEach(item => {
                resList.innerHTML += `
                    <div class="additive-box ${item.risk}">
                        <strong>${item.name}</strong><br>
                        <small>${item.info}</small>
                    </div>`;
            });
        } else {
            resList.innerHTML = "<p>Keine kritischen Inhaltsstoffe im Text gefunden.</p>";
        }
        
        saveHistory({ name: "Text-Scan", date: new Date().toLocaleString(), items: found });
        document.getElementById('result').classList.remove('hidden');
        document.getElementById('status').innerText = "Analyse abgeschlossen.";
    }

    function showResult(name, additives) {
        const resList = document.getElementById('res-list');
        resList.innerHTML = "";
        
        let items = additives.map(a => {
            const code = a.replace('en:', '');
            return MASTER_DB[code] || { name: code, risk: "low", info: "Zusatzstoff." };
        });

        items.forEach(item => {
            resList.innerHTML += `
                <div class="additive-box ${item.risk}">
                    <strong>${item.name}</strong><br>
                    <small>${item.info}</small>
                </div>`;
        });

        document.getElementById('res-name').innerText = name;
        saveHistory({ name, date: new Date().toLocaleString(), items });
        document.getElementById('result').classList.remove('hidden');
    }

    function saveHistory(entry) {
        let history = JSON.parse(localStorage.getItem('nutrition_history') || "[]");
        history.unshift(entry);
        localStorage.setItem('nutrition_history', JSON.stringify(history.slice(0, 50)));
        renderHistory();
    }

    function renderHistory() {
        const history = JSON.parse(localStorage.getItem('nutrition_history') || "[]");
        document.getElementById('history-list').innerHTML = history.map(h => `
            <div style="border-bottom:1px solid #eee; padding:5px 0;">
                <b>${h.name}</b> - <small>${h.date}</small>
            </div>
        `).join('') || "Kein Verlauf.";
    }

    function exportData() {
        const history = JSON.parse(localStorage.getItem('nutrition_history') || "[]");
        let txt = "ERNÄHRUNGS-REPORT\n\n";
        history.forEach(h => {
            txt += `${h.name} (${h.date})\n`;
            h.items.forEach(i => txt += `- ${i.name}: ${i.info}\n`);
            txt += "-------------------\n";
        });
        navigator.clipboard.writeText(txt);
        alert("Bericht mit allen Inhaltsstoff-Details wurde kopiert!");
    }

    function resetUI() { document.getElementById('result').classList.add('hidden'); }

    window.onload = startCamera;
</script>
</body>
</html>
