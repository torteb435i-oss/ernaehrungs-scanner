<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nutrition AI Vision Pro - Final Fix</title>
    
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    
    <style>
        :root { --primary: #007AFF; --bg: #f5f5f7; --text: #1d1d1f; --green: #34c759; --red: #ff3b30; --warn: #ff9500; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; color: var(--text); }
        .container { width: 92%; max-width: 440px; margin: 20px auto; }
        header { background: white; padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        #reader { width: 100%; border-radius: 20px; overflow: hidden; background: #000; }
        .btn { background: var(--primary); color: white; border: none; padding: 18px; border-radius: 18px; font-size: 1rem; font-weight: bold; width: 100%; cursor: pointer; margin-top: 10px; }
        
        .card { background: white; border-radius: 25px; padding: 20px; margin-top: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .status { text-align: center; padding: 10px; font-size: 0.8rem; color: var(--primary); font-weight: bold; }
        
        .additive-item { padding: 12px; border-bottom: 0.5px solid #eee; font-size: 0.9rem; line-height: 1.4; }
        .risk-high { color: var(--red); } .risk-med { color: var(--warn); } .risk-low { color: var(--green); }
        .summary { background: #f0f7ff; padding: 15px; border-radius: 15px; border-left: 5px solid var(--primary); margin: 15px 0; font-size: 0.95rem; }
    </style>
</head>
<body>

<header><h2>NUTRITION VISION PRO</h2></header>

<div class="container">
    <div id="reader"></div>
    <div id="status" class="status">Kamera wird gestartet...</div>

    <div id="controls">
        <button id="btn-load" class="btn" style="background: var(--green);" onclick="initKI()">1. KI INITIALISIEREN</button>
        <button id="btn-scan" class="btn hidden" onclick="scanNow()">2. TEXT ANALYSIEREN</button>
    </div>

    <div id="result" class="card hidden">
        <h3 id="res-name">Analyse-Ergebnis</h3>
        <div id="res-summary" class="summary"></div>
        <div id="res-details"></div>
        <button class="btn" style="background:#8e8e93;" onclick="location.reload()">Neu Scannen</button>
    </div>
</div>

<script>
    let html5QrCode;
    let worker = null;

    // DIE MASTER-DATENBANK MIT ALLEN DETAILS
    const DB = {
        "e440": { name: "Pektin (E440)", risk: "low", info: "Detaillierte Info: Natürliches Geliermittel aus Äpfeln. Sehr gesund, wirkt als Ballaststoff und fördert die Verdauung." },
        "pektin": { name: "Pektin", risk: "low", info: "Detaillierte Info: Pflanzlicher Stoff. Unbedenklich und gesund." },
        "e621": { name: "Glutamat (E621)", risk: "high", info: "Detaillierte Info: Geschmacksverstärker. Kann bei empfindlichen Personen Kopfschmerzen auslösen und das Sättigungsgefühl stören." },
        "e250": { name: "Nitritpökelsalz", risk: "high", info: "Detaillierte Info: Konservierungsmittel für Fleisch. Gilt als potenziell krebserregend beim Erhitzen." },
        "e330": { name: "Zitronensäure", risk: "low", info: "Detaillierte Info: Natürliche Säure. Unbedenklich, schützt vor Verfärbungen." },
        "zucker": { name: "Zucker / Sirup", risk: "med", info: "Detaillierte Info: Hoher Anteil an leeren Kalorien. Belastet den Insulinspiegel." },
        "palm": { name: "Palmfett", risk: "med", info: "Detaillierte Info: Industrielles Fett. Kritisch für Herzgesundheit und Umwelt (Regenwald)." }
    };

    // 1. Kamera starten
    function startCam() {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, () => {});
        document.getElementById('status').innerText = "Kamera aktiv. Halte den Text ruhig davor.";
    }

    // 2. KI laden
    async function initKI() {
        document.getElementById('status').innerText = "Lade KI-Gehirn (bitte warten)...";
        worker = await Tesseract.createWorker('deu');
        document.getElementById('btn-load').classList.add('hidden');
        document.getElementById('btn-scan').classList.remove('hidden');
        document.getElementById('status').innerText = "KI BEREIT! Jetzt Text scannen.";
    }

    // 3. Den eigentlichen Scan durchführen
    async function scanNow() {
        document.getElementById('status').innerText = "KI liest den Text... bitte nicht bewegen!";
        const video = document.querySelector('video');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        try {
            const { data: { text } } = await worker.recognize(canvas);
            analyzeText(text);
        } catch (e) {
            alert("Fehler beim Lesen. Bitte näher ran!");
        }
    }

    // 4. Den Text mit der Datenbank abgleichen
    function analyzeText(rawText) {
        const text = rawText.toLowerCase();
        console.log("Gelesen:", text); // Debugging im Browser-Log
        
        let foundAny = false;
        let detailsHtml = "<h4>Gefundene Stoffe:</h4>";
        let score = "Gut";

        // Datenbank-Abgleich
        for (let key in DB) {
            if (text.includes(key)) {
                foundAny = true;
                const item = DB[key];
                const riskClass = "risk-" + item.risk;
                detailsHtml += `<div class="additive-item"><b class="${riskClass}">${item.name}</b><br>${item.info}</div>`;
                if(item.risk === 'high') score = "Kritisch";
            }
        }

        if (!foundAny) {
            detailsHtml += "<p>Keine bekannten Zusatzstoffe im Scan erkannt. Probiere es näher oder mit mehr Licht.</p>";
        }

        // Anzeige
        document.getElementById('result').classList.remove('hidden');
        document.getElementById('res-summary').innerHTML = `<b>Gesamt-Urteil: ${score}</b><br>Basierend auf dem Text-Scan der Inhaltsstoffe.`;
        document.getElementById('res-details').innerHTML = detailsHtml;
        document.getElementById('status').innerText = "Analyse abgeschlossen!";
    }

    window.onload = startCam;
</script>
</body>
</html>
