<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nutrition AI Vision Pro - Expert</title>
    
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    
    <style>
        :root {
            --primary: #007AFF; --bg: #f5f5f7; --glass: rgba(255, 255, 255, 0.8);
            --text: #1d1d1f; --green: #34c759; --red: #ff3b30; --warn: #ff9500;
        }
        @media (prefers-color-scheme: dark) {
            :root { --bg: #000000; --glass: rgba(28, 28, 30, 0.9); --text: #f5f5f7; }
        }

        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; color: var(--text); overflow-x: hidden; }
        header { background: var(--glass); backdrop-filter: blur(20px); padding: 20px; text-align: center; border-bottom: 0.5px solid rgba(120,120,120,0.2); position: sticky; top: 0; z-index: 100; }
        
        .container { width: 92%; max-width: 440px; margin: 20px auto; padding-bottom: 50px; }
        
        .mode-switch { display: flex; gap: 8px; margin-bottom: 15px; background: rgba(120,120,120,0.1); padding: 5px; border-radius: 14px; }
        .mode-btn { flex: 1; padding: 12px; border-radius: 10px; border: none; background: none; font-weight: 600; cursor: pointer; color: var(--text); }
        .mode-btn.active { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); color: var(--primary); }

        #reader-wrapper { width: 100%; border-radius: 25px; overflow: hidden; background: #000; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #reader { width: 100%; }
        #status-bar { padding: 10px; text-align: center; font-size: 0.85rem; font-weight: 600; color: var(--primary); }

        .btn { background: var(--primary); color: white; border: none; padding: 18px; border-radius: 18px; font-size: 1rem; font-weight: 700; width: 100%; cursor: pointer; margin-top: 10px; }
        .card { background: var(--glass); backdrop-filter: blur(30px); border-radius: 25px; padding: 22px; margin-top: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid rgba(150,150,150,0.1); }

        .score-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 15px 0; }
        .score-box { background: rgba(120,120,120,0.08); padding: 15px; border-radius: 18px; text-align: center; }
        
        .summary-box { background: rgba(0, 122, 255, 0.1); border-left: 5px solid var(--primary); padding: 15px; border-radius: 12px; margin: 15px 0; font-size: 0.9rem; line-height: 1.4; }
        
        .additive-item { padding: 12px; border-bottom: 0.5px solid rgba(120,120,120,0.1); font-size: 0.85rem; }
        .risk-high { color: var(--red); font-weight: bold; }
        .risk-med { color: var(--warn); font-weight: bold; }
        .risk-low { color: var(--green); font-weight: bold; }
        
        .hidden { display: none !important; }
        .history-item { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding: 10px 0; border-bottom: 1px solid rgba(120,120,120,0.1); font-size: 0.9rem; }
    </style>
</head>
<body>

<header><h1>NUTRITION VISION PRO</h1></header>

<div class="container">
    <div class="mode-switch">
        <button id="btn-barcode" class="mode-btn active" onclick="setMode('barcode')">Barcode</button>
        <button id="btn-text" class="mode-btn" onclick="setMode('text')">Zutaten-Scan</button>
    </div>

    <div id="reader-wrapper">
        <div id="reader"></div>
        <div id="status-bar">Kamera bereit</div>
        <div id="ocr-controls" class="hidden" style="padding: 15px;">
            <button id="load-ocr-btn" class="btn" style="background:#34c759" onclick="prepareAI()">1. KI laden</button>
            <button id="scan-ocr-btn" class="btn hidden" onclick="runOCR()">2. Text analysieren</button>
        </div>
    </div>

    <div id="result-card" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="res-title" style="margin:0; font-size:1.3rem;">Produkt</h2>
            <div id="res-grade" style="font-size:2.5rem; font-weight:900;">-</div>
        </div>

        <div class="score-grid">
            <div class="score-box"><big id="res-nova">üçè</big><br><small id="res-nova-text">Natur</small></div>
            <div class="score-box"><big id="res-health">‚öñÔ∏è</big><br><small id="res-health-text">Status</small></div>
        </div>

        <div id="res-summary" class="summary-box"></div>

        <div id="details-section">
            <h4 style="margin: 15px 0 5px;">Inhalts-Analyse:</h4>
            <div id="additive-list"></div>
        </div>

        <button class="btn" style="background:#8e8e93; margin-top:20px;" onclick="closeResult()">Schlie√üen</button>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0;">Verlauf (Letzte 50)</h3>
            <button onclick="exportHistory()" style="background:none; border:none; color:var(--primary); font-weight:bold; cursor:pointer;">EXPORT</button>
        </div>
        <div id="history-list"></div>
    </div>
</div>

<script>
    let scanner;
    let ocrWorker = null;
    let mode = 'barcode';

    // DEEP ANALYSIS DATENBANK (E-Nummern & Klarnamen)
    const NUTRITION_DB = {
        "e440": { name: "Pektin", risk: "low", desc: "Pflanzliches Geliermittel aus Fr√ºchten. Sehr gesund & ballaststoffreich." },
        "e412": { name: "Guarkernmehl", risk: "low", desc: "Pflanzliches Verdickungsmittel. Gut vertr√§glich." },
        "e415": { name: "Xanthan", risk: "low", desc: "Nat√ºrlicher Mehrfachzucker. Unbedenklich." },
        "e621": { name: "Glutamat", risk: "med", desc: "Geschmacksverst√§rker. Kann S√§ttigungsgef√ºhl st√∂ren." },
        "e250": { name: "Nitritp√∂kelsalz", risk: "high", desc: "Kritisch. Potenziell krebserregend in Fleisch." },
        "e171": { name: "Titandioxid", risk: "high", desc: "In EU verboten. Kann Darmbarriere sch√§digen." },
        "e330": { name: "Zitronens√§ure", risk: "low", desc: "Nat√ºrliche S√§ure, unbedenklich." },
        "e951": { name: "Aspartam", risk: "med", desc: "S√º√üstoff. Umstritten bei hohem Konsum." },
        "e102": { name: "Tartrazin", risk: "high", desc: "Farbstoff. Kann Hyperaktivit√§t f√∂rdern." },
        "e407": { name: "Carrageen", risk: "med", desc: "Algenextrakt. Steht im Verdacht, Darmreizungen zu f√∂rdern." },
        "maltodextrin": { name: "Maltodextrin", risk: "med", desc: "Industriezucker. L√§sst Insulin schnell steigen." },
        "palm": { name: "Industriefett", risk: "med", desc: "Palmfett/√ñl. Schlecht f√ºr Herz & Umwelt." }
    };

    async function initCamera() {
        if (scanner) await scanner.stop();
        scanner = new Html5Qrcode("reader");
        const config = { fps: 15, qrbox: { width: 250, height: 180 } };
        
        if (mode === 'barcode') {
            document.getElementById('ocr-controls').classList.add('hidden');
            scanner.start({ facingMode: "environment" }, config, (code) => {
                fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json?fields=product_name,nutrition_grades,nova_group,additives_tags,allergens_tags`)
                .then(r => r.json()).then(d => { if(d.status === 1) buildAnalysis(d.product); });
            });
        } else {
            document.getElementById('ocr-controls').classList.remove('hidden');
            scanner.start({ facingMode: "environment" }, config, () => {}); 
        }
    }

    async function prepareAI() {
        document.getElementById('status-bar').innerText = "KI-Daten werden geladen...";
        ocrWorker = await Tesseract.createWorker('deu');
        document.getElementById('load-ocr-btn').classList.add('hidden');
        document.getElementById('scan-ocr-btn').classList.remove('hidden');
        document.getElementById('status-bar').innerText = "KI bereit!";
    }

    async function runOCR() {
        document.getElementById('status-bar').innerText = "Lese Inhaltsstoffe...";
        const video = document.querySelector('video');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        const { data: { text } } = await ocrWorker.recognize(canvas);
        const lower = text.toLowerCase();
        
        const found = [];
        Object.keys(NUTRITION_DB).forEach(key => {
            if (lower.includes(key) || lower.includes(NUTRITION_DB[key].name.toLowerCase())) {
                found.push("en:" + (key.startsWith('e') ? key : 'custom_' + key));
            }
        });

        buildAnalysis({
            product_name: "Text-Analyse",
            nutrition_grades: (lower.includes("zucker") || lower.includes("sirup")) ? "d" : "b",
            nova_group: found.length > 2 ? 4 : 2,
            additives_tags: found,
            isOCR: true
        });
    }

    function buildAnalysis(p) {
        document.getElementById('result-card').classList.remove('hidden');
        document.getElementById('res-title').innerText = p.product_name || "Unbekannt";
        
        const grade = (p.nutrition_grades || "c").toUpperCase();
        document.getElementById('res-grade').innerText = grade;
        document.getElementById('res-grade').style.color = grade <= 'B' ? 'var(--green)' : (grade >= 'D' ? 'var(--red)' : 'var(--warn)');

        const nova = p.nova_group || 3;
        document.getElementById('res-nova').innerText = nova >= 4 ? "üè≠" : "üçè";
        document.getElementById('res-nova-text').innerText = nova >= 4 ? "Hochverarbeitet" : "Naturnah";

        // Deep Analysis & Fazit
        const additives = p.additives_tags || [];
        const riskLevel = additives.some(t => {
            const code = t.replace('en:', '').replace('custom_', '');
            return NUTRITION_DB[code]?.risk === 'high';
        });

        let summary = "Dieses Produkt scheint ausgewogen zu sein.";
        if (nova >= 4) summary = "Vorsicht: Dies ist ein hochverarbeitetes Industrieprodukt.";
        if (riskLevel) summary += " Es wurden kritische Inhaltsstoffe gefunden.";
        if (p.isOCR) summary = "KI-Fazit basierend auf Textscan: " + summary;
        
        document.getElementById('res-summary').innerText = summary;

        const list = document.getElementById('additive-list');
        list.innerHTML = "";
        additives.forEach(tag => {
            const code = tag.replace('en:', '').replace('custom_', '');
            const info = NUTRITION_DB[code] || { name: code.toUpperCase(), risk: "low", desc: "Zusatzstoff." };
            list.innerHTML += `<div class="additive-item"><span class="risk-${info.risk}">${info.name}</span>: ${info.desc}</div>`;
        });
        
        saveHistory(p);
    }

    function saveHistory(p) {
        let db = JSON.parse(localStorage.getItem('nutritionDB')) || [];
        db.unshift({ name: p.product_name, grade: (p.nutrition_grades || "C").toUpperCase(), date: new Date().toLocaleDateString() });
        localStorage.setItem('nutritionDB', JSON.stringify(db.slice(0, 50)));
        renderHistory();
    }

    function renderHistory() {
        const db = JSON.parse(localStorage.getItem('nutritionDB')) || [];
        document.getElementById('history-list').innerHTML = db.map(i => `
            <div class="history-item">
                <span><b>${i.name}</b><br><small>${i.date}</small></span>
                <span style="font-weight:900; color:${i.grade <= 'B' ? 'var(--green)' : 'var(--red)'}">${i.grade}</span>
            </div>`).join('') || '<p style="text-align:center; opacity:0.5;">Noch keine Scans.</p>';
    }

    function setMode(m) { mode = m; document.getElementById('btn-barcode').classList.toggle('active', m === 'barcode'); document.getElementById('btn-text').classList.toggle('active', m === 'text'); initCamera(); }
    function closeResult() { document.getElementById('result-card').classList.add('hidden'); }
    function exportHistory() { const db = JSON.parse(localStorage.getItem('nutritionDB')) || []; alert("Exportiere " + db.length + " Eintr√§ge..."); console.log(db); }

    window.onload = () => { renderHistory(); initCamera(); };
</script>
</body>
</html>
