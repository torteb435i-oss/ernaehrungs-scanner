<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nutrition Vision Pro - Ultra Edition</title>
    
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    
    <style>
        :root { 
            --primary: #007AFF; --bg: #f2f2f7; --text: #1c1c1e; 
            --green: #34c759; --red: #ff3b30; --warn: #ff9500; --card: #ffffff;
        }
        @media (prefers-color-scheme: dark) {
            :root { --bg: #000000; --text: #ffffff; --card: #1c1c1e; }
        }

        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; color: var(--text); }
        header { background: var(--card); padding: 25px 20px; text-align: center; box-shadow: 0 2px 15px rgba(0,0,0,0.1); border-bottom: 0.5px solid #333; }
        
        .container { width: 92%; max-width: 480px; margin: 20px auto; padding-bottom: 60px; }
        
        #reader-container { 
            width: 100%; border-radius: 28px; overflow: hidden; background: #000; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.3); position: relative; border: 3px solid var(--primary);
        }
        #reader { width: 100%; }
        
        .status-bar { padding: 12px; text-align: center; font-weight: 700; color: var(--primary); font-size: 0.9rem; letter-spacing: 0.5px; }

        .btn { 
            background: var(--primary); color: white; border: none; padding: 20px; 
            border-radius: 20px; font-size: 1.1rem; font-weight: 800; width: 100%; 
            cursor: pointer; transition: transform 0.2s; margin-top: 15px;
        }
        .btn:active { transform: scale(0.98); }

        /* Detail-Karten Design */
        .analysis-card { background: var(--card); border-radius: 24px; padding: 22px; margin-top: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        .ingredient-box { 
            padding: 16px; border-radius: 18px; margin-bottom: 15px; 
            background: rgba(120,120,120,0.05); border-left: 8px solid #ccc;
        }
        .risk-low { border-left-color: var(--green); }
        .risk-med { border-left-color: var(--warn); }
        .risk-high { border-left-color: var(--red); }

        .tag-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .tag-name { font-weight: 900; font-size: 1.1rem; }
        .tag-type { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; opacity: 0.6; }
        .tag-desc { font-size: 0.95rem; line-height: 1.5; opacity: 0.9; }

        .summary-badge { display: block; text-align: center; padding: 10px; border-radius: 12px; font-weight: 800; margin-bottom: 20px; }
        
        .hidden { display: none !important; }
        #canvas-buffer { display: none; }
    </style>
</head>
<body>

<header><h1>NUTRITION VISION PRO <span style="font-size: 0.6rem; vertical-align: middle; background: var(--red); padding: 3px 6px; border-radius: 4px;">ULTRA</span></h1></header>

<div class="container">
    <div id="reader-container">
        <div id="reader"></div>
        <div class="status-bar" id="status">INITIALISIERE KI-OPTIC...</div>
    </div>
    
    <button id="scan-btn" class="btn" onclick="performDeepAnalysis()">JETZT TIEFEN-SCAN STARTEN</button>

    <div id="result" class="analysis-card hidden">
        <div id="health-summary" class="summary-badge"></div>
        <h3 style="margin-top:0;">Gefundene Inhaltsstoffe:</h3>
        <div id="details-list"></div>
        <button class="btn" style="background:#8e8e93;" onclick="closeResult()">NEUER SCAN</button>
    </div>
</div>

<canvas id="canvas-buffer"></canvas>

<script>
    let html5QrCode;
    let worker;

    // DIE ULTIMATIVE KLARTEXT-DATENBANK
    const MASTER_DB = {
        // ZUCKER-FALLEN
        "maltodextrin": { name: "Maltodextrin", type: "Tarn-Zucker", risk: "med", desc: "Hochverarbeitete St√§rke. L√§sst den Blutzucker massiv ansteigen, f√∂rdert Hei√ühunger." },
        "dextrose": { name: "Dextrose", type: "Einfachzucker", risk: "med", desc: "Traubenzucker. Belastet die Bauchspeicheldr√ºse und liefert leere Kalorien." },
        "glukose": { name: "Glukose-Sirup", type: "Industrie-S√º√üe", risk: "high", desc: "Billiger F√ºllstoff. Verursacht schnelle Fetteinlagerung in der Leber." },
        "sucralose": { name: "Sucralose (E955)", type: "S√º√üstoff", risk: "low", desc: "Kalorienfrei. Z√§hne-schonend, aber t√§uscht dem Gehirn Energie vor." },
        
        // FETT-FALLEN
        "palm": { name: "Palmfett / √ñl", type: "Industriefett", risk: "high", desc: "Enth√§lt viele ges√§ttigte Fetts√§uren. Schlecht f√ºr Herz & Regenwald." },
        "geh√§rtet": { name: "Geh√§rtete Fette", type: "Trans-Fette", risk: "high", desc: "Sehr ungesund. Erh√∂ht das Risiko f√ºr Gef√§√üverkalkung deutlich." },

        // ZUSATZSTOFFE (E-NUMMERN) IM KLARTEXT
        "e440": { name: "Pektin (E440)", type: "Geliermittel", risk: "low", desc: "Aus √Ñpfeln gewonnen. Ein gesunder Ballaststoff f√ºr die Darmflora." },
        "e322": { name: "Lecithin (E322)", type: "Emulgator", risk: "low", desc: "Wichtiger Stoff f√ºr Gehirn & Nerven. Bindet Fett und Wasser perfekt." },
        "e621": { name: "Glutamat (E621)", type: "Verst√§rker", risk: "high", desc: "Neurotransmitter-Trick. Schaltet das nat√ºrliche S√§ttigungsgef√ºhl aus." },
        "e250": { name: "Nitrit (E250)", type: "Konservierung", risk: "high", desc: "P√∂kelsalz. Kann krebserregende Nitrosamine bilden. Meiden!" },
        "e412": { name: "Guarkernmehl", type: "Verdickung", risk: "low", desc: "Pflanzlich. S√§ttigt gut, aber Vorsicht bei empfindlichem Magen." }
    };

    async function init() {
        html5QrCode = new Html5Qrcode("reader");
        await html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: 280 }, () => {});
        document.getElementById('status').innerText = "KI-OPTIC AKTIV: TEXT FOKUSSIEREN";
        worker = await Tesseract.createWorker('deu');
    }

    async function performDeepAnalysis() {
        const status = document.getElementById('status');
        status.innerText = "ERFASSE BILDDATEN...";
        
        const video = document.querySelector('video');
        const canvas = document.getElementById('canvas-buffer');
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        
        // Bildoptimierung f√ºr OCR (Kontrast & Sch√§rfe)
        ctx.filter = 'contrast(1.4) grayscale(1)';
        ctx.drawImage(video, 0, 0);

        status.innerText = "KI ANALYSIERT TEXTSTRUKTUR...";
        const { data: { text } } = await worker.recognize(canvas);
        
        analyze(text.toLowerCase());
    }

    function analyze(rawText) {
        const detailsList = document.getElementById('details-list');
        const summary = document.getElementById('health-summary');
        detailsList.innerHTML = "";
        let found = [];
        let maxRisk = 'low';

        // Check gegen Datenbank
        for (let key in MASTER_DB) {
            if (rawText.includes(key)) {
                found.push(MASTER_DB[key]);
                if (MASTER_DB[key].risk === 'high') maxRisk = 'high';
                else if (MASTER_DB[key].risk === 'med' && maxRisk !== 'high') maxRisk = 'med';
            }
        }

        if (found.length > 0) {
            found.forEach(item => {
                detailsList.innerHTML += `
                    <div class="ingredient-box risk-${item.risk}">
                        <div class="tag-row">
                            <span class="tag-name">${item.name}</span>
                            <span class="tag-type">${item.type}</span>
                        </div>
                        <p class="tag-desc">${item.desc}</p>
                    </div>`;
            });
            
            // Fazit Logik
            if(maxRisk === 'high') {
                summary.innerText = "‚ö†Ô∏è KRITISCH: MEIDEN ODER REDUZIEREN";
                summary.style.background = "var(--red)"; summary.style.color = "white";
            } else if(maxRisk === 'med') {
                summary.innerText = "‚öñÔ∏è MITTELM√ÑSSIG: INDUSTRIELLE ZUTATEN";
                summary.style.background = "var(--warn)"; summary.style.color = "black";
            } else {
                summary.innerText = "üçè POSITIV: NATURNAHE INHALTSSTOFFE";
                summary.style.background = "var(--green)"; summary.style.color = "white";
            }
        } else {
            detailsList.innerHTML = "<p style='text-align:center; padding: 20px;'>Keine bekannten Problemstoffe erkannt. <br><small>Tipp: Halte die Kamera ruhiger und n√§her an den Text.</small></p>";
            summary.innerText = "UNKLAR: TEXT NICHT LESBAR";
            summary.style.background = "#ccc";
        }

        document.getElementById('result').classList.remove('hidden');
        document.getElementById('status').innerText = "ANALYSE ABGESCHLOSSEN";
    }

    function closeResult() { document.getElementById('result').classList.add('hidden'); document.getElementById('status').innerText = "KI-OPTIC AKTIV"; }
    window.onload = init;
</script>
</body>
</html>
