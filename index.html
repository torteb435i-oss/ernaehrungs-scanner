<script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>

<style>
    .ocr-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,122,255,0.2); display: flex; align-items: center; justify-content: center;
        color: white; font-weight: bold; pointer-events: none;
    }
    .analysis-card { border-left: 5px solid var(--warn); padding-left: 10px; margin: 10px 0; }
</style>

<div class="role-nav" style="margin-bottom: 10px;">
    <button id="mode-barcode" class="active" onclick="setScanMode('barcode')">Barcode</button>
    <button id="mode-text" onclick="setScanMode('text')">Inhaltsliste lesen</button>
</div>

<script>
    let scanMode = 'barcode';

    function setScanMode(mode) {
        scanMode = mode;
        document.getElementById('mode-barcode').classList.toggle('active', mode === 'barcode');
        document.getElementById('mode-text').classList.toggle('active', mode === 'text');
    }

    async function analyzeIngredientsText() {
        // 1. Snapshot vom Video-Feed machen
        const video = document.querySelector('#reader video');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        // 2. OCR starten
        Tesseract.recognize(canvas, 'deu', { logger: m => console.log(m) })
            .then(({ data: { text } }) => {
                evaluateText(text);
            });
    }

    function evaluateText(text) {
        const ingredients = text.toLowerCase();
        let findings = [];
        
        // Suche nach kritischen Begriffen
        if(ingredients.includes("zucker")) findings.push("Viel Zucker");
        if(ingredients.includes("palmfett") || ingredients.includes("palm√∂l")) findings.push("Palmfett (Umwelt)");
        
        // E-Nummern extrahieren
        const eMatch = ingredients.match(/e\s?\d{3,4}/g);
        if(eMatch) findings.push(...eMatch);

        showOcrResult(findings, text);
    }
</script>
