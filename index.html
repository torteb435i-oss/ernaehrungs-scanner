<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nutrition AI Pro - Fixed</title>
    
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    
    <style>
        :root { --primary: #007AFF; --bg: #f5f5f7; --text: #1d1d1f; --green: #34c759; --red: #ff3b30; --warn: #ff9500; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; color: var(--text); }
        .container { width: 92%; max-width: 440px; margin: 20px auto; padding-bottom: 40px; }
        header { background: white; padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        #reader-container { width: 100%; border-radius: 20px; overflow: hidden; background: #000; position: relative; min-height: 250px; }
        #reader { width: 100%; }
        
        .mode-nav { display: flex; gap: 10px; margin: 15px 0; }
        .mode-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; background: #ddd; font-weight: bold; cursor: pointer; }
        .mode-btn.active { background: var(--primary); color: white; }

        .btn { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 15px; font-size: 1rem; font-weight: bold; width: 100%; cursor: pointer; margin-top: 10px; }
        .card { background: white; border-radius: 20px; padding: 20px; margin-top: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        
        .status { text-align: center; padding: 10px; font-size: 0.8rem; font-weight: bold; color: var(--primary); }
        .additive-item { padding: 10px 0; border-bottom: 0.5px solid #eee; font-size: 0.85rem; }
        .risk-high { color: var(--red); } .risk-med { color: var(--warn); } .risk-low { color: var(--green); }
        
        .history-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.8rem; display: flex; justify-content: space-between; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<header><strong>NUTRITION AI VISION</strong></header>

<div class="container">
    <div class="mode-nav">
        <button id="nav-barcode" class="mode-btn active" onclick="switchMode('barcode')">BARCODE</button>
        <button id="nav-text" class="mode-btn" onclick="switchMode('text')">ZUTATEN-SCAN</button>
    </div>

    <div id="reader-container">
        <div id="reader"></div>
        <div id="ocr-btn-container" class="hidden" style="position: absolute; bottom: 10px; width: 100%; text-align: center; z-index: 10;">
            <button class="btn" style="width: 80%; background: var(--green);" onclick="captureAndOCR()">JETZT TEXT ANALYSIEREN</button>
        </div>
    </div>
    
    <div id="status" class="status">Kamera wird geladen...</div>

    <div id="result-card" class="card hidden">
        <h3 id="res-title" style="margin:0;">Analyse</h3>
        <p id="res-summary" style="font-weight:bold;"></p>
        <div id="res-details"></div>
        <button class="btn" style="background:#8e8e93;" onclick="closeResult()">Schließen</button>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h4 style="margin:0;">VERLAUF</h4>
            <button onclick="exportData()" style="background:none; border:none; color:var(--primary); font-weight:bold;">EXPORT</button>
        </div>
        <div id="history-list"></div>
    </div>
</div>

<script>
    let scanner;
    let worker;
    let currentMode = 'barcode';

    const DB = {
        "e440": { name: "Pektin (E440)", risk: "low", info: "Natürlicher Ballaststoff. Sehr gesund." },
        "pektin": { name: "Pektin", risk: "low", info: "Pflanzlich. Unbedenklich." },
        "maltodextrin": { name: "Maltodextrin", risk: "med", info: "Versteckter Zucker. Belastet Insulinstatus." },
        "e621": { name: "Glutamat", risk: "high", info: "Geschmacksverstärker. Kann Sättigung stören." },
        "palm": { name: "Palmfett", risk: "med", info: "Industriefett. Bedenklich für Herz/Umwelt." }
    };

    async function init() {
        if(scanner) await scanner.stop();
        scanner = new Html5Qrcode("reader");
        renderHistory();
        
        const config = { fps: 10, qrbox: { width: 250, height: 150 } };
        
        if(currentMode === 'barcode') {
            document.getElementById('ocr-btn-container').classList.add('hidden');
            scanner.start({ facingMode: "environment" }, config, (decodedText) => {
                fetch(`https://world.openfoodfacts.org/api/v2/product/${decodedText}.json`)
                .then(r => r.json()).then(d => { if(d.status === 1) processResult(d.product.product_name, d.product.additives_tags || []); });
            });
            document.getElementById('status').innerText = "Bereit für Barcode...";
        } else {
            document.getElementById('ocr-btn-container').classList.remove('hidden');
            scanner.start({ facingMode: "environment" }, config, () => {});
            if(!worker) {
                document.getElementById('status').innerText = "KI lädt...";
                worker = await Tesseract.createWorker('deu');
                document.getElementById('status').innerText = "Text-Scan bereit!";
            }
        }
    }

    async function captureAndOCR() {
        document.getElementById('status').innerText = "KI liest Zutaten...";
        const video = document.querySelector('video');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        const { data: { text } } = await worker.recognize(canvas);
        const lower = text.toLowerCase();
        let found = [];
        for(let key in DB) { if(lower.includes(key)) found.push("en:" + key); }
        processResult("Text-Scan", found, text.substring(0, 50));
    }

    function processResult(name, tags, rawText = "") {
        const details = tags.map(t => {
            const code = t.replace('en:', '');
            return DB[code] || { name: code, risk: "low", info: "Zusatzstoff." };
        });

        const entry = { name, date: new Date().toLocaleString(), details };
        saveHistory(entry);
        
        document.getElementById('result-card').classList.remove('hidden');
        document.getElementById('res-title').innerText = name;
        document.getElementById('res-details').innerHTML = details.map(i => `
            <div class="additive-item"><b class="risk-${i.risk}">${i.name}</b>: ${i.info}</div>
        `).join('') || "Keine spezifischen Stoffe erkannt.";
        document.getElementById('status').innerText = "Analyse fertig.";
    }

    function saveHistory(entry) {
        let h = JSON.parse(localStorage.getItem('nutriHistory') || "[]");
        h.unshift(entry);
        localStorage.setItem('nutriHistory', JSON.stringify(h.slice(0, 50)));
        renderHistory();
    }

    function renderHistory() {
        const h = JSON.parse(localStorage.getItem('nutriHistory') || "[]");
        document.getElementById('history-list').innerHTML = h.map(i => `
            <div class="history-item"><span>${i.name}</span><small>${i.date}</small></div>
        `).join('') || "Keine Scans.";
    }

    function exportData() {
        const h = JSON.parse(localStorage.getItem('nutriHistory') || "[]");
        let txt = "ERNÄHRUNGSBERICHT\n\n";
        h.forEach(s => {
            txt += `${s.name} (${s.date})\nInhaltsstoffe:\n` + 
                   s.details.map(d => `- ${d.name}: ${d.info}`).join('\n') + "\n\n";
        });
        navigator.clipboard.writeText(txt);
        alert("Bericht mit allen Details in Zwischenablage kopiert!");
    }

    function switchMode(m) {
        currentMode = m;
        document.getElementById('nav-barcode').classList.toggle('active', m === 'barcode');
        document.getElementById('nav-text').classList.toggle('active', m === 'text');
        init();
    }

    function closeResult() { document.getElementById('result-card').classList.add('hidden'); }
    window.onload = init;
</script>
</body>
</html>
