<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nutrition AI - Expert Edition</title>
    
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    
    <style>
        :root { --primary: #007AFF; --green: #34c759; --red: #ff3b30; --warn: #ff9500; --bg: #f2f2f7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; color: #1c1c1e; }
        header { background: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { width: 92%; max-width: 440px; margin: 20px auto; }
        
        #reader-wrapper { border-radius: 25px; overflow: hidden; border: 3px solid var(--primary); background: #000; position: relative; }
        
        .card { background: white; border-radius: 25px; padding: 20px; margin-top: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .btn { background: var(--primary); color: white; border: none; padding: 18px; border-radius: 18px; font-size: 1rem; font-weight: bold; width: 100%; cursor: pointer; margin-top: 10px; }
        
        /* EXPERTEN DETAILS */
        .additive-item { padding: 15px; border-radius: 15px; margin-bottom: 12px; background: #f8f9fa; border-left: 6px solid #ccc; }
        .risk-low { border-left-color: var(--green); }
        .risk-med { border-left-color: var(--warn); }
        .risk-high { border-left-color: var(--red); }
        
        .add-name { font-weight: 800; font-size: 1.1rem; color: #000; }
        .add-info { font-size: 0.9rem; margin-top: 5px; line-height: 1.4; color: #444; }
        .add-usage { font-size: 0.75rem; color: var(--primary); text-transform: uppercase; font-weight: bold; margin-top: 4px; display: block; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<header><strong>LEBENSMITTEL-DETEKTIV PRO</strong></header>

<div class="container">
    <div id="reader-wrapper"><div id="reader"></div></div>
    
    <button class="btn" style="background:var(--green);" onclick="scanText()">ZUTATEN-TEXT ANALYSIEREN</button>

    <div id="result" class="card hidden">
        <h2 id="res-name" style="margin-top:0;">Analyse</h2>
        <div id="res-list"></div>
        <button class="btn" onclick="location.reload()">Neuer Scan</button>
    </div>
</div>

<script>
    // DIE ULTIMATIVE ENTSCHLÜSSELUNGS-DATENBANK
    const ADDITIVE_WIKI = {
        // Konservierungsstoffe
        "e250": { name: "Natriumnitrit", usage: "Konservierung (Pökelsalz)", risk: "high", info: "Verhindert Bakterien in Fleisch, kann aber krebserregende Nitrosamine bilden. Meiden!" },
        "e202": { name: "Kaliumsorbat", usage: "Konservierung", risk: "low", info: "Hemmt Hefen und Schimmel. Gilt als unbedenklich, kann aber bei Allergikern Reaktionen auslösen." },
        
        // Farbstoffe
        "e102": { name: "Tartrazin (Gelb)", usage: "Farbstoff", risk: "high", info: "Kann Aktivität und Aufmerksamkeit bei Kindern beeinträchtigen (Azo-Farbstoff)." },
        "e171": { name: "Titandioxid", usage: "Farbstoff (Weiß)", risk: "high", info: "In der EU mittlerweile in Lebensmitteln verboten. Steht im Verdacht, das Erbgut zu schädigen." },

        // Geliermittel & Verdicker
        "e440": { name: "Pektin", usage: "Geliermittel", risk: "low", info: "Natürlicher Stoff aus Äpfeln/Zitrusfrüchten. Ein wertvoller Ballaststoff." },
        "e412": { name: "Guarkernmehl", usage: "Verdicker", risk: "low", info: "Pflanzlich. Sättigt gut, kann in hohen Mengen aber leicht abführend wirken." },
        "e415": { name: "Xanthan", usage: "Verdicker", risk: "low", info: "Durch Fermentation gewonnen. Völlig harmlos und oft in Bio-Produkten." },

        // Süßstoffe & Zuckerersatz
        "e951": { name: "Aspartam", usage: "Süßstoff", risk: "med", info: "Extrem süß, kalorienfrei. Umstritten, da es bei manchen Menschen Kopfschmerzen auslöst." },
        "e955": { name: "Sucralose", usage: "Süßstoff", risk: "low", info: "Zahnfreundlich und stabil beim Backen. Gilt nach aktuellem Stand als sicher." },

        // Geschmacksverstärker
        "e621": { name: "Mononatriumglutamat", usage: "Verstärker", risk: "high", info: "Triggert das Gehirn ('Umami'). Kann zu Überessen führen und Heißhunger auslösen." },

        // Emulgatoren
        "e322": { name: "Lecithin", usage: "Emulgator", risk: "low", info: "Meist aus Soja oder Raps. Wichtig für den Fettstoffwechsel und die Nerven." }
    };

    let html5QrCode, worker;

    async function init() {
        html5QrCode = new Html5Qrcode("reader");
        await html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (code) => {
            fetchBarcode(code);
        });
        worker = await Tesseract.createWorker('deu');
    }

    async function fetchBarcode(code) {
        const r = await fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json?fields=product_name,additives_tags`);
        const d = await r.json();
        if(d.status === 1) renderResults(d.product.product_name, d.product.additives_tags || []);
    }

    async function scanText() {
        const video = document.querySelector('video');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const { data: { text } } = await worker.recognize(canvas);
        
        let foundTags = [];
        const lower = text.toLowerCase();
        for(let key in ADDITIVE_WIKI) {
            if(lower.includes(key) || lower.includes(ADDITIVE_WIKI[key].name.toLowerCase())) {
                foundTags.push("en:" + key);
            }
        }
        renderResults("Text-Analyse", foundTags);
    }

    function renderResults(name, tags) {
        document.getElementById('res-name').innerText = name;
        const list = document.getElementById('res-list');
        list.innerHTML = "";
        
        tags.forEach(t => {
            const key = t.replace('en:', '').toLowerCase();
            const data = ADDITIVE_WIKI[key] || { name: key.toUpperCase(), usage: "Zusatzstoff", risk: "low", info: "Keine detaillierte Warnung in der Datenbank vorhanden." };
            
            list.innerHTML += `
                <div class="additive-item risk-${data.risk}">
                    <span class="add-usage">${data.usage}</span>
                    <span class="add-name">${data.name}</span>
                    <p class="add-info">${data.info}</p>
                </div>
            `;
        });

        if(tags.length === 0) list.innerHTML = "<p>Keine spezifischen E-Stoffe erkannt.</p>";
        document.getElementById('result').classList.remove('hidden');
    }

    window.onload = init;
</script>
</body>
</html>
